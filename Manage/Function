#!/bin/env bash
source $AFYZHOME/config
TitleText=$1
function CheckFile(){
if [ ! -e $1 ]
then
  $(TUISoftware) --title "${TitleText}" \
  --msgbox "æ–‡ä»¶ä¸å­˜åœ¨" \
  $(MsgboxSize)
  exit
fi
}

Number=$($(TUISoftware) \
--title "${TitleText}" \
--menu "$(MenuTips)" \
$(MenuSize) \
"1" "ä¿®æ”¹è´¦å·" \
"2" "ä¿®æ”¹ç­¾å" \
"3" "ä¿®æ”¹ä¸»äºº" \
"4" "å…¨é‡å¤‡ä»½" \
"0" "  è¿”å›ž  " \
3>&1 1>&2 2>&3)
case ${Number} in
1)
  case $(jq .name package.json) in
  "trss-yunzai")
    $(TUISoftware) --title "${TitleText}" \
    --msgbox "TRSS-Yunzai æš‚æ— æ³•ä¿®æ”¹" \
    $(MsgboxSize)
    exit
    ;;
  esac
  ConfigFile="config/config/qq.yaml"
  CheckFile ${ConfigFile}
  OldQQ="$(grep qq: ${ConfigFile})"
  OldPwd="$(grep pwd: ${ConfigFile})"
  OldPlatform="$(grep platform: ${ConfigFile})"
  if ! NewQQ=$($(TUISoftware) --title "${TitleText}" \
  --yes-button "ç¡®è®¤" \
  --no-button "è¿”å›ž" \
  --inputbox "è¯·è¾“å…¥æ‚¨çš„QQè´¦å·" \
  $(MsgboxSize) \
  3>&1 1>&2 2>&3)
  then
    exit 0
  fi
  if ! OldPwd=$($(TUISoftware) --title "${TitleText}" \
  --yes-button "ç¡®è®¤" \
  --no-button "è¿”å›ž" \
  --inputbox "è¯·è¾“å…¥æ‚¨çš„QQå¯†ç " \
  $(MsgboxSize) \
  3>&1 1>&2 2>&3)
  then
    exit 0
  fi
  NewPlatform=$($(TUISoftware) \
  --title "${TitleText}" \
  --menu "$(MenuTips)" \
  $(MenuSize) \
  "1" "å®‰å“æ‰‹æœº" \
  "2" "aPad" \
  "3" "å®‰å“æ‰‹è¡¨" \
  "4" "MacOS" \
  "5" "iPad" \
  "6" "Tim" \
  3>&1 1>&2 2>&3)
  if $(TUISoftware) --title "${TitleText}" \
  --yes-button "ç¡®è®¤" \
  --no-button "è¿”å›ž" \
  --inputbox "QQ: ${NewQQ}\nå¯†ç : ${OldPwd}" \
  $(MsgboxSize)
  then
    sed -i "s|${OldQQ}|qq: ${NewQQ}|g" ${ConfigFile}
    sed -i "s|${OldPwd}|pwd: ${OldPwd}|g" ${ConfigFile}
    sed -i "s|${OldPlatform}|platform: ${NewPlatform}|g" ${ConfigFile}
  else
    exit 0
  fi
;;
2)
  case $(jq .name package.json) in
  "trss-yunzai")
    $(TUISoftware) --title "${TitleText}" \
    --msgbox "TRSS-Yunzai æš‚æ— æ³•ä¿®æ”¹" \
    $(MsgboxSize)
    exit
    ;;
  esac
  ConfigFile="config/config/bot.yaml"
  CheckFile ${ConfigFile}
  if NewSignApiAddr=$($(TUISoftware) --title "${TitleText}" \
  --yes-button "ç¡®è®¤" \
  --no-button "è¿”å›ž" \
  --inputbox "è¯·è¾“å…¥æ‚¨çš„ç­¾åæœåŠ¡å™¨é“¾æŽ¥" \
  $(MsgboxSize) \
  3>&1 1>&2 2>&3)
  then
    OldSignApiAddr="$(grep sign_api_addr ${ConfigFile})"
    OldSignApiAddr="$(grep sign_api_addr ${ConfigFile})"
    NewSignApiAddr=$(echo ${NewSignApiAddr} | sed "s|sign_api_addr: ||g")
    sed -i "s|${OldSignApiAddr}|sign_api_addr: ${NewSignApiAddr}|g" ${ConfigFile}
    API=$(grep sign_api_addr ${ConfigFile} | sed "s|sign_api_addr: ||g")
    $(TUISoftware) --title "${TitleText}" \
    --msgbox "ç­¾åAPIå·²ä¿®æ”¹ä¸º\n${API}" \
    $(MsgboxSize)
  else
    exit
  fi
;;
3)
  ConfigFile="config/config/other.yaml"
  CheckFile ${ConfigFile}
  if MasterQQ=$($(TUISoftware) --title "${TitleText}" \
  --yes-button "ç¡®è®¤" \
  --no-button "è¿”å›ž" \
  --inputbox "è¯·è¾“å…¥æ‚¨çš„ä¸»äººè´¦å·" \
  $(MsgboxSize) \
  3>&1 1>&2 2>&3)
  then
    if echo ${MasterQQ} | grep -qE '^[0-9]+$'
    then
      sed -i "/masterQQ/a\  - ${MasterQQ}" ${ConfigFile}
    else
      MasterQQ=\"${MasterQQ}\"
      sed -i "/masterQQ/a\  - ${MasterQQ}" ${ConfigFile}
    fi
  else
    exit 0
  fi
;;
4)
  unset Exclude i Options
  BotFOLDER=$(basename $(pwd))
  if [ -d /mnt/c ]
  then
    for i in $(ls /mnt)
    do
      Options="${Options} ${i} ðŸ¥"
    done
    FOLDER=$($(TUISoftware) \
    --title "${TitleText}" \
    --menu "è¯·é—®æ‚¨è¦å°†å¤‡ä»½æ–‡ä»¶æ”¾ç½®äºŽå“ªé‡Œ?" \
    $(MenuSize) \
    ${Options} \
    3>&1 1>&2 2>&3)
    FilePath="/mnt/${FOLDER}/${BotFOLDER}"
  else
    if [ -d /sdcard/Download ]
    then
      FilePath="/sdcard/Download/${BotFOLDER}"
    else
      FilePath="./${BotFOLDER}"
    fi
  fi
  echo -e ${yellow}æ­£åœ¨æ‰§è¡Œ ${green}git gc${background}
  git gc
  for i in $(ls plugins)
  do
    if [ -d plugins/${i}/.git ];then
      cd plugins/${i}
      git gc
      cd ../..
    fi
  done
  echo -e ${yellow}æ‰§è¡Œå®Œæˆ${background}
  echo -e ${yellow}æ­£åœ¨ç»Ÿè®¡ ${green}æ–‡ä»¶æŽ’é™¤é¡¹${background}
  for i in $(ls plugins)
  do
    if [ -d plugins/${i}/node_modules ];then
      Exclude="${Exclude} --exclude=plugins/${i}/node_modules"
    fi
  done
  cd ..
  Exclude="${Exclude} --exclude=${BotFOLDER}/node_modules"
  echo -e ${yellow}ç»Ÿè®¡å®Œæˆ${background}
  if ($(TUISoftware) --title "${TitleText}"  \
  --yes-button "ä»…å½’æ¡£" \
  --no-button "åŽ‹ç¼©" \
  --yesno "æ˜¯å¦åŽ‹ç¼©${BotFOLDER} \nè¿™å¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„æ—¶é—´æ¶ˆè€—" \
  $(MsgboxSize))
  then
    tar -cf - ${Exclude} ${BotFOLDER} | pv > ${FilePath}.tar
  else  
    tar -cf - ${Exclude} ${BotFOLDER} | pv | xz > ${FilePath}.tar.xz
  fi
  echo -e ${green}æ–‡ä»¶å·²å¤‡ä»½è‡³${FilePath} ${cyan}å›žè½¦è¿”å›ž${background};read
;;
0)
exit
;;
esac