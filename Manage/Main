#!/bin/env bash
source ../config
cd $HOME

if ping -c 1 api.arcticfox.top 2>&1 > /dev/null
then
  curl -sL -o "/dev/null" https://api.arcticfox.top/add
fi

VersionURL="https://raw.githubusercontent.com/ArcticFox520/Yunzai-Script/main/version"
if CheckNetwork
then
  CloudVersion="$(curl -sL https://mirror.ghproxy.com/${VersionURL})"
else
  CloudVersion="$(curl -sL ${VersionURL})"
fi
LocalVersion="$(cat $AFYZHOME/version)"
if [ ! -z "${CloudVersion}" ]
then
  if [ "${LocalVersion}" != "${CloudVersion}" ]
  then
    afyz up
    exit
  fi
fi

function SecondMenu(){
Number=$($(TUISoftware) \
--title "${TitleText}" \
--menu "$(MenuTips)" \
$(MenuSize) \
"1" "å¯åŠ¨è¿è¡Œ" \
"2" "å‰å°å¯åŠ¨" \
"3" "åœæ­¢è¿è¡Œ" \
"4" "é‡æ–°å¯åŠ¨" \
"5" "æ‰“å¼€æ—¥å¿—" \
"6" "æ’ä»¶ç®¡ç†" \
"7" "å…¨éƒ¨æ›´æ–°" \
"8" "å…¶ä»–åŠŸèƒ½" \
"9" "è¿›å…¥bash" \
"0" "  è¿”å›  " \
3>&1 1>&2 2>&3)
case ${Number} in
1)
  if StartType ${BotName} ${COMMAND} ${Pm2Name}
  then
    if Error=$(ManageSession $(Session) start "${BotName}" "afyz ${BotName} start")
    then
      if ProgressBar ${BotName} ${COMMAND} ${Pm2Name}
      then
        if ($(TUISoftware) --title "${TitleText}"  \
        --yes-button "æ‰“å¼€æ—¥å¿—" \
        --no-button "è¿”å›èœå•" \
        --yesno "${BotName} [å¯åŠ¨æˆåŠŸ]" \
        $(MsgboxSize))
        then
          if ! Error=$(ManageSession $(Session) log "${BotName}")
          then
            $(TUISoftware) --title "${TitleText}" \
            --msgbox "${BotName} [æ‰“å¼€å¤±è´¥] \nåŸå› : ${Error}" \
            $(MsgboxSize)
            SecondMenu
          fi
        else
          SecondMenu
        fi
      else
        $(TUISoftware) --title "${TitleText}" \
        --msgbox "${BotName} [å¯åŠ¨å¤±è´¥] \nåŸå› : ${Error}" \
        $(MsgboxSize)
        SecondMenu
      fi
    else
      SecondMenu
    fi
  else
    SecondMenu
  fi
;;
2)
  if StartType ${BotName} ${COMMAND} ${Pm2Name}
  then
    START "${StartCommand}" ${Pm2Name}
  else
    SecondMenu
  fi
;;
3)
  if CheckStatus ${BotName} ${COMMAND} ${Pm2Name}
  then
    $(TUISoftware) --title "${TitleText}" \
    --msgbox "${BotName} [æ— æ³•åœæ­¢] \nåŸå› : ${BotName} [æœªè¿è¡Œ]" \
    $(MsgboxSize)
    SecondMenu
  else
    if Error=$(StopBot ${BotName} ${COMMAND} ${Pm2Name})
    then
      $(TUISoftware) --title "${TitleText}" \
      --msgbox "${BotName} [åœæ­¢æˆåŠŸ]" \
      $(MsgboxSize)
      SecondMenu
    else
      $(TUISoftware) --title "${TitleText}" \
      --msgbox "${BotName} [åœæ­¢é”™è¯¯] \nåŸå› : ${Error}" \
      $(MsgboxSize)
      SecondMenu
    fi
  fi
;;
4)
  if CheckStatus ${BotName} ${COMMAND} ${Pm2Name}
  then
    $(TUISoftware) --title "${TitleText}" \
    --msgbox "${BotName} [æ— æ³•é‡å¯] \nåŸå› : ${BotName} [æœªè¿è¡Œ]" \
    $(MsgboxSize)
    SecondMenu
  else
    if Error=$(RestartBot ${BotName} ${COMMAND} ${Pm2Name})
    then
      if ProgressBar ${BotName} ${COMMAND} ${Pm2Name}
      then
        if ($(TUISoftware) --title "${TitleText}"  \
        --yes-button "æ‰“å¼€æ—¥å¿—" \
        --no-button "è¿”å›èœå•" \
        --yesno "${BotName} [é‡å¯æˆåŠŸ]" \
        $(MsgboxSize))
        then
          if ! Error=$(ManageSession $(Session) log "${BotName}")
          then
            $(TUISoftware) --title "${TitleText}" \
            --msgbox "${BotName} [æ‰“å¼€å¤±è´¥] \nåŸå› : ${Error}" \
            $(MsgboxSize)
            SecondMenu
          fi
        else
          SecondMenu
        fi
      else
        $(TUISoftware) --title "${TitleText}" \
        --msgbox "${BotName} [å¯åŠ¨å¤±è´¥] \nåŸå› : ${Error}" \
        $(MsgboxSize)
        SecondMenu
      fi
    else
      $(TUISoftware) --title "${TitleText}" \
      --msgbox "${BotName} [é‡å¯é”™è¯¯] \nåŸå› : ${Error}" \
      $(MsgboxSize)
      SecondMenu
    fi
  fi
;;
5)
  if CheckStatus ${BotName} ${COMMAND} ${Pm2Name}
  then
    $(TUISoftware) --title "${TitleText}" \
    --msgbox "${BotName} æ—¥å¿— [æ— æ³•æ‰“å¼€] \nåŸå› : ${BotName} [æœªè¿è¡Œ]" \
    $(MsgboxSize)
    SecondMenu
  else
    if ! Error=$(LogBot ${BotName} ${COMMAND} ${Pm2Name})
    then
      $(TUISoftware) --title "${TitleText}" \
      --msgbox "${BotName} [é”™è¯¯] \nåŸå› : ${Error}" \
      $(MsgboxSize)
      SecondMenu
    fi
  fi
;;
6)
  bash $AFYZHOME/Manage/Plugin
  SecondMenu
;;
7)
  echo -e ${yellow}æ­£åœ¨æ›´æ–° ${yellow}${BotName}${background}
  if git pull
  then
    echo -e ${yellow}${BotName} ${green}æ›´æ–°å®Œæˆ${background}
  else
    echo -e ${yellow}${BotName}${red}æ›´æ–°å¤±è´¥${background}
  fi
  for i in $(ls plugins)
  do
    if [ -e plugins/${i}/.git/config ]
    then
      cd plugins/${i}
      echo -e ${yellow}æ­£åœ¨æ›´æ–° ${cyan}${i}${background}
      if git pull
      then
        echo -e ${yellow}${i} ${green}æ›´æ–°å®Œæˆ${background}
      else
        echo -e ${yellow}${i} ${red}æ›´æ–°å¤±è´¥${background}
      fi
    fi
  done
;;
8)
  bash $AFYZHOME/Manage/Function ${TitleText}
  SecondMenu
;;
9)
  exec bash
  SecondMenu
;;
0)
  return 5
;;
esac
}
function Install(){
case $1 in
MZ)
  if ! bash ../Install
  then
    exit 1
  fi
  source ../config
  if ! bash ../Linux/Pnpm
  then
    exit 1
  fi
  if ! bash ../Linux/GitBot MZ
  then
    exit 1
  fi
;;
TZ)
  if ! bash ../Install
  then
    exit 1
  fi
  source ../config
  if ! bash ../Linux/Pnpm
  then
    exit 1
  fi
  if ! bash ../Linux/GitBot TZ
  then
    exit 1
  fi
;;
YN)
  if ! bash ../Install
  then
    exit 1
  fi
  source ../config
  if ! bash ../Linux/Yarn
  then
    exit 1
  fi
  if ! bash ../Linux/GitBot YN
  then
    exit 1
  fi
;;
esac
}
function MainMenu(){
Number=$($(TUISoftware) \
--title "AF-Script" \
--menu "$(MenuTips)" \
$(MenuSize) \
"1" "Miao-Yunzai" \
"2" "TRSS-Yunzai" \
"3" "Yunzai-Bot" \
"4" " è¿›å…¥BASH " \
"0" " é€€å‡ºè„šæœ¬ " \
3>&1 1>&2 2>&3)
if [ $? == 1 ]
then
  return 5
fi
case ${Number} in
  1)
    if CheckInstall MZ
    then
      TitleText="AF-MZ"
      BotName="Miao-Yunzai"
      COMMAND="Miao-Yun"
      StartCommand="node app"
      Pm2Name="Miao-Yunzai"
      SecondMenu
    else
      if ($(TUISoftware) --title "AF-Script"  \
      --yes-button "å®‰è£…" \
      --no-button "è¿”å›" \
      --yesno "Miao-Yunzai [æœªå®‰è£…]\næ˜¯å¦ç«‹åˆ»å¼€å§‹å®‰è£…" \
      $(MsgboxSize))
      then
        Install MZ
        TitleText="AF-MZ"
        BotName="Miao-Yunzai"
        COMMAND="Miao-Yun"
        StartCommand="node app"
        Pm2Name="Miao-Yunzai"
        SecondMenu
      else
        MainMenu
      fi
    fi
  ;;
  2)
    if CheckInstall TZ
    then
      TitleText="AF-TZ"
      BotName="TRSS-Yunzai"
      COMMAND="TRSS Yunzai"
      StartCommand="node app"
      Pm2Name="TRSS-Yunzai"
      SecondMenu
    else
      if ($(TUISoftware) --title "AF-Script"  \
      --yes-button "å®‰è£…" \
      --no-button "è¿”å›" \
      --yesno "Yunzai-TRSS [æœªå®‰è£…]\næ˜¯å¦ç«‹åˆ»å¼€å§‹å®‰è£…" \
      $(MsgboxSize))
      then
        Install TZ
        TitleText="AF-TZ"
        BotName="TRSS-Yunzai"
        COMMAND="TRSS Yunzai"
        StartCommand="node app"
        Pm2Name="TRSS-Yunzai"
        SecondMenu
      else
        MainMenu
      fi
    fi
  ;;
  3)
    $(TUISoftware) --title "${TitleText}" \
    --msgbox "Yunzai-Nextåœæ­¢å®‰è£… æ¢å¤æ—¶é—´çœ‹æˆ‘å¿ƒæƒ… ğŸŒ¿" \
    $(MsgboxSize)
    SecondMenu
    exit
    if CheckInstall YN
    then
      TitleText="AF-YZ-Next"
      BotName="Yunzai-Next"
      COMMAND="YZ-NEXT"
      StartCommand="node src/main"
      Pm2Name="yunzai-next"
      SecondMenu
    esle
      if ($(TUISoftware) --title "AF-Script"  \
      --yes-button "å®‰è£…" \
      --no-button "è¿”å›" \
      --yesno "Yunzai-Bot [æœªå®‰è£…]\næ˜¯å¦ç«‹åˆ»å¼€å§‹å®‰è£…" \
      $(MsgboxSize))
      then
        Install YN
        TitleText="AF-YZ-Next"
        BotName="Yunzai-Next"
        COMMAND="YZ-NEXT"
        StartCommand="node src/main"
        Pm2Name="yunzai-next"
        SecondMenu
      else
        MainMenu
      fi
    fi
  ;;
  4)
    exec bash -i
  ;;
  0)
    return 5
  ;;
esac
}
function WhileMainMenu(){
  while true
  do
    MainMenu
    if [ $? == 5 ]
    then
      exit 0
    fi
    WhileMainMenu
  done
}
WhileMainMenu