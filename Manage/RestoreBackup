#!/bin/env bash
source ../config
if ! bash ../Install
then
  exit 1
fi
if ! bash ../Linux/Pnpm
then
  exit 1
fi
if ! bash ../Linux/Yarn
then
  exit 1
fi
cd $HOME

function DependenciesInstall(){
if CheckNetwork
then
  NPMMirror="https://registry.npmmirror.com"
else
  NPMMirror="https://registry.npmjs.org"
fi
case $(jq '.name' package.json) in
yunzai-next)
  pkg=yarn
  ;;
*)
  pkg=pnpm
  ;;
esac
for i in $(ls plugins)
do
  if [ -e plugins/${i}/package.json ]
  then
    cd plugins/${i}
    echo -e ${yellow}æ­£åœ¨å®‰è£… ${green}${i}${cyan}æ’ä»¶ä¾èµ–${background}
    if ${pkg} install --registry=${NPMMirror}
    then
      echo -e ${green}å®‰è£…æˆåŠŸ${background}
      cd ../..
    else
      echo -e ${red}å®‰è£…å¤±è´¥${background}
      cd ../..
    fi
  fi
done
if ${pkg} install --registry=${NPMMirror}
then
  echo -e ${green}å®‰è£…æˆåŠŸ${background}
  cd ../..
else
  echo -e ${red}å®‰è£…å¤±è´¥${background}
  cd ../..
fi
}

unset Options
if [ -d /mnt/c ]
then
  for i in $(ls /mnt)
  do
    if [ -e /mnt/${i}/*.tar ]
    then
      FolderPath="/mnt/${i}/"
      for i in $(ls /mnt/${i}/*.tar)
      do          
        Options="${Options} ${i} ğŸ¥"
      done
    elif [ -e /mnt/${i}/*.tar.xz ]
    then
      FolderPath="/mnt/${i}/"
      for i in $(ls /mnt/${i}/*.tar.xz)
      do
        Options="${Options} ${i} ğŸ¥"
      done
    else
      $(TUISoftware) --title "${TitleText}" \
      --msgbox "é”™è¯¯: æœªèƒ½æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶" \
      $(MsgboxSize)
      exit
    fi
  done
else
  if [ -d /sdcard/Download ]
  then
    if [ -e /sdcard/Download/*.tar ]
    then
      FolderPath="/sdcard/Download/"
      for i in $(ls /sdcard/Download/*.tar)
      do          
        Options="${Options} ${i} ğŸ¥"
      done
    elif [ -e /sdcard/Download/*.tar.xz ]
    then
      FolderPath="/sdcard/Download/"
      for i in $(ls /mnt/${i}/*.tar.xz)
      do          
        Options="${Options} ${i} ğŸ¥"
      done
    else
      $(TUISoftware) --title "${TitleText}" \
      --msgbox "é”™è¯¯ æœªèƒ½æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶\nLinuxç³»ç»Ÿè¯·æ”¾ç½®äºæ ¹ç›®å½•ä¸‹\nWindowsç³»ç»Ÿè¯·æ”¾ç½®äºä»»æ„ä¸€ä¸ªç›˜çš„æ ¹ç›®å½•ä¸‹\nå®‰å“ç³»ç»Ÿè¯·æ”¾ç½®äºä¸‹è½½æ–‡ä»¶å¤¹(Download)" \
      $(MsgboxSize)
      exit
    fi
  else
    if [ -e /*.tar.xz ]
    then
      $(TUISoftware) --title "${TitleText}" \
      --msgbox "é”™è¯¯ æœªèƒ½æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶\nLinuxç³»ç»Ÿè¯·æ”¾ç½®äºæ ¹ç›®å½•ä¸‹\nWindowsç³»ç»Ÿè¯·æ”¾ç½®äºä»»æ„ä¸€ä¸ªç›˜çš„æ ¹ç›®å½•ä¸‹\nå®‰å“ç³»ç»Ÿè¯·æ”¾ç½®äºä¸‹è½½æ–‡ä»¶å¤¹(Download)" \
      $(MsgboxSize)
      exit
    fi
  fi
fi
BackupFile=$($(TUISoftware) \
--title "${TitleText}" \
--menu "è¯·é€‰æ‹©æ‚¨çš„å¤‡ä»½æ–‡ä»¶:" \
$(MenuSize) \
${Options} \
3>&1 1>&2 2>&3)
if [ -e ${BackupFile} ]
then
  if echo -e ${BackupFile} | grep -q xz
  then
    FOLDER=$(echo ${BackupFile} | sed "s|${FolderPath}||g" | sed 's|.tar.xz||g')
    if [ -d ${FOLDER} ]
    then
      echo -e ${red}é”™è¯¯ ${black}æ–‡ä»¶å¤¹å·²å­˜åœ¨${background}
      exit
    fi
    mkdir FOLDER
    echo -e ${yellow}å¼€å§‹è§£å‹${background}
    pv ${BackupFile} | tar -Jxf - -C FOLDER
    echo -e ${yellow}æ­£åœ¨ç§»åŠ¨${background}
    mv FOLDER/$(ls FOLDER) ${FOLDER}
    rm -rf FOLDER
    cd ${FOLDER}
    DependenciesInstall
    echo -e ${green}æ¢å¤å®Œæˆ ${cyan}å›è½¦è¿”å›${background};read
  else
    FOLDER=$(echo ${BackupFile} | sed "s|${FolderPath}||g" | sed 's|.tar||g')
    if [ -d ${FOLDER} ]
    then
      echo -e ${red}é”™è¯¯ ${black}æ–‡ä»¶å¤¹å·²å­˜åœ¨${background}
      exit
    fi
    mkdir FOLDER
    echo -e ${yellow}å¼€å§‹è§£å‹${background}
    pv ${BackupFile} | tar -xf - -C FOLDER
    echo -e ${yellow}æ­£åœ¨ç§»åŠ¨${background}
    mv FOLDER/$(ls FOLDER) ${FOLDER}
    rm -rf FOLDER
    cd ${FOLDER}
    DependenciesInstall
    echo -en ${green}æ¢å¤å®Œæˆ ${cyan}å›è½¦è¿”å›${background};read
  fi
  echo -e ${red}é”™è¯¯ ${black}æ–‡ä»¶ä¸å­˜åœ¨${background}
  exit
fi
